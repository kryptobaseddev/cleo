name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

permissions:
  contents: write

jobs:
  release:
    name: Build and Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: |
          # Extract version from tag (remove 'v' prefix)
          VERSION="${GITHUB_REF_NAME#v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Building release for version: $VERSION"

      - name: Validate required files exist
        run: |
          for path in scripts lib schemas templates skills installer completions docs VERSION LICENSE README.md install.sh; do
            if [[ ! -e "$path" ]]; then
              echo "ERROR: Required path missing: $path"
              exit 1
            fi
          done
          echo "All required files present"

      - name: Build runtime tarball
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TARBALL="cleo-${VERSION}.tar.gz"

          # Create staging directory
          mkdir -p "staging/cleo-${VERSION}"

          # Copy runtime components only
          # NOTE: Must match SOURCE_INSTALLABLE_DIRS in installer/lib/source.sh
          cp -r scripts "staging/cleo-${VERSION}/"
          cp -r lib "staging/cleo-${VERSION}/"
          cp -r schemas "staging/cleo-${VERSION}/"
          cp -r templates "staging/cleo-${VERSION}/"
          cp -r skills "staging/cleo-${VERSION}/"
          cp -r installer "staging/cleo-${VERSION}/"
          cp -r completions "staging/cleo-${VERSION}/"
          cp -r docs "staging/cleo-${VERSION}/"
          cp VERSION "staging/cleo-${VERSION}/"
          cp LICENSE "staging/cleo-${VERSION}/"
          cp README.md "staging/cleo-${VERSION}/"

          # Set execute permissions on shell scripts
          find "staging/cleo-${VERSION}" -name "*.sh" -exec chmod +x {} \;
          chmod +x "staging/cleo-${VERSION}/installer/install.sh"
          chmod +x "staging/cleo-${VERSION}/cleo" 2>/dev/null || true
          echo "Set execute permissions on shell scripts"

          # Create tarball
          tar -czvf "$TARBALL" -C staging "cleo-${VERSION}"

          echo "Created: $TARBALL"
          ls -lh "$TARBALL"

      - name: Prepare standalone installer
        run: |
          # Ensure install.sh is executable for release
          chmod +x install.sh
          echo "Standalone installer ready: $(wc -l < install.sh) lines"

      - name: Generate checksums
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          TARBALL="cleo-${VERSION}.tar.gz"

          # Generate SHA256 checksums
          sha256sum "$TARBALL" install.sh > SHA256SUMS

          echo "Checksums:"
          cat SHA256SUMS

      - name: Generate release notes
        id: changelog
        env:
          VERSION: ${{ steps.version.outputs.version }}
          REPO: ${{ github.repository }}
        run: |
          # Source changelog functions
          source lib/changelog.sh

          echo "## [${VERSION}] - $(date +%Y-%m-%d)" > release-notes.txt
          echo "" >> release-notes.txt

          # Strategy 1: Try to extract from CHANGELOG.md
          if extract_changelog_section "v${VERSION}" "CHANGELOG.md" "changelog-section.txt" 2>/dev/null; then
            echo "✓ Found changelog entry for v${VERSION}"
            cat changelog-section.txt >> release-notes.txt
            echo "source=changelog" >> "$GITHUB_OUTPUT"
          else
            echo "⚠ No CHANGELOG.md entry for v${VERSION} - generating from commits"

            # Strategy 2: Generate from git commits since last tag
            PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

            if [[ -n "$PREV_TAG" ]]; then
              echo "Generating from commits since $PREV_TAG"

              # Use the generate_changelog_from_commits function
              if COMMIT_CHANGELOG=$(generate_changelog_from_commits "$PREV_TAG" "HEAD" 2>/dev/null); then
                if [[ -n "$COMMIT_CHANGELOG" && "$COMMIT_CHANGELOG" != "null" ]]; then
                  echo "$COMMIT_CHANGELOG" >> release-notes.txt
                  echo "source=commits" >> "$GITHUB_OUTPUT"
                else
                  # Fallback: Simple commit list
                  echo "### Changes" >> release-notes.txt
                  git log --pretty=format:"- %s" --no-merges "${PREV_TAG}..HEAD" >> release-notes.txt
                  echo "" >> release-notes.txt
                  echo "source=commit-list" >> "$GITHUB_OUTPUT"
                fi
              else
                # Fallback: Simple commit list
                echo "### Changes" >> release-notes.txt
                git log --pretty=format:"- %s" --no-merges "${PREV_TAG}..HEAD" >> release-notes.txt
                echo "" >> release-notes.txt
                echo "source=commit-list" >> "$GITHUB_OUTPUT"
              fi
            else
              # No previous tag - list recent commits
              echo "### Changes" >> release-notes.txt
              git log --pretty=format:"- %s" --no-merges -20 >> release-notes.txt
              echo "" >> release-notes.txt
              echo "source=recent-commits" >> "$GITHUB_OUTPUT"
            fi
          fi

          echo ""
          echo "=== Generated Release Notes ==="
          cat release-notes.txt
          echo "==============================="

          echo "path=release-notes.txt" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: ${{ steps.changelog.outputs.path }}
          generate_release_notes: false
          files: |
            cleo-${{ steps.version.outputs.version }}.tar.gz
            install.sh
            SHA256SUMS
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
