name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'

permissions:
  contents: write
  id-token: write

jobs:
  release:
    name: Build and Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Get version from tag
        id: version
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Building release for version: $VERSION"

      - name: Validate CalVer (YYYY.M.PATCH)
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          # Extract base version (strip pre-release suffix)
          BASE_VERSION=$(echo "$VERSION" | cut -d- -f1)
          TAG_YEAR=$(echo "$BASE_VERSION" | cut -d. -f1)
          TAG_MONTH=$(echo "$BASE_VERSION" | cut -d. -f2)

          # Get current UTC year and month
          CURRENT_YEAR=$(date -u +%Y)
          CURRENT_MONTH=$(date -u +%-m)

          # Calculate next month (for pre-release flexibility)
          if [[ "$CURRENT_MONTH" -eq 12 ]]; then
            NEXT_MONTH=1
            NEXT_YEAR=$((CURRENT_YEAR + 1))
          else
            NEXT_MONTH=$((CURRENT_MONTH + 1))
            NEXT_YEAR=$CURRENT_YEAR
          fi

          echo "Tag: ${TAG_YEAR}.${TAG_MONTH}.x"
          echo "Now: ${CURRENT_YEAR}.${CURRENT_MONTH}"

          # Check if this is a pre-release tag
          IS_PRERELEASE=false
          if [[ "$VERSION" == *"-"* ]]; then
            IS_PRERELEASE=true
            echo "Pre-release detected: $(echo "$VERSION" | cut -d- -f2-)"
          fi

          if [[ "$IS_PRERELEASE" == "true" ]]; then
            # Pre-release: year must match current or next month's year
            if [[ "$TAG_YEAR" != "$CURRENT_YEAR" ]] && [[ "$TAG_YEAR" != "$NEXT_YEAR" ]]; then
              echo "ERROR: Pre-release tag year ${TAG_YEAR} does not match current (${CURRENT_YEAR}) or next month's year (${NEXT_YEAR})"
              exit 1
            fi
            # Pre-release: month can be current or next month
            if [[ "$TAG_MONTH" != "$CURRENT_MONTH" ]] && [[ "$TAG_MONTH" != "$NEXT_MONTH" ]]; then
              echo "ERROR: Pre-release tag month ${TAG_MONTH} does not match current (${CURRENT_MONTH}) or next month (${NEXT_MONTH})"
              exit 1
            fi
            echo "CalVer validated (pre-release): ${TAG_YEAR}.${TAG_MONTH} within allowed range"
          else
            # Stable: strict year and month match required
            if [[ "$TAG_YEAR" != "$CURRENT_YEAR" ]]; then
              echo "ERROR: Tag year ${TAG_YEAR} does not match current year ${CURRENT_YEAR}"
              exit 1
            fi
            if [[ "$TAG_MONTH" != "$CURRENT_MONTH" ]]; then
              echo "ERROR: Tag month ${TAG_MONTH} does not match current month ${CURRENT_MONTH}"
              echo "CalVer requires YYYY.M.PATCH where M is the current month"
              exit 1
            fi
            echo "CalVer validated (stable): ${TAG_YEAR}.${TAG_MONTH} matches current date"
          fi

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run build

      - name: Validate build output
        run: |
          for path in dist/cli/index.js dist/mcp/index.js schemas templates packages/ct-skills/skills; do
            if [[ ! -e "$path" ]]; then
              echo "ERROR: Required path missing: $path"
              exit 1
            fi
          done
          echo "All required build artifacts present"

      - name: Build release tarball
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          TARBALL="cleo-${VERSION}.tar.gz"

          mkdir -p "staging/cleo-${VERSION}"

          # Copy npm-publishable components (matches package.json "files")
          cp -r dist "staging/cleo-${VERSION}/"
          cp -r schemas "staging/cleo-${VERSION}/"
          cp -r templates "staging/cleo-${VERSION}/"
          cp -r packages/ct-skills/skills "staging/cleo-${VERSION}/"
          [[ -d completions ]] && cp -r completions "staging/cleo-${VERSION}/"
          cp package.json "staging/cleo-${VERSION}/"
          cp VERSION "staging/cleo-${VERSION}/"
          cp LICENSE "staging/cleo-${VERSION}/"
          cp README.md "staging/cleo-${VERSION}/"
          cp install.sh "staging/cleo-${VERSION}/"

          # Ensure executables have correct permissions
          chmod +x "staging/cleo-${VERSION}/dist/cli/index.js"
          chmod +x "staging/cleo-${VERSION}/dist/mcp/index.js"
          chmod +x "staging/cleo-${VERSION}/install.sh"

          tar -czvf "$TARBALL" -C staging "cleo-${VERSION}"

          echo "Created: $TARBALL"
          ls -lh "$TARBALL"

      - name: Prepare standalone installer
        run: |
          chmod +x install.sh
          echo "Standalone installer ready: $(wc -l < install.sh) lines"

      - name: Generate checksums
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          TARBALL="cleo-${VERSION}.tar.gz"
          sha256sum "$TARBALL" install.sh > SHA256SUMS
          echo "Checksums:"
          cat SHA256SUMS

      - name: Generate release notes
        id: changelog
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          echo "## [${VERSION}] - $(date +%Y-%m-%d)" > release-notes.txt
          echo "" >> release-notes.txt

          # Extract from CHANGELOG.md if available
          if grep -q "## \[${VERSION}\]" CHANGELOG.md 2>/dev/null; then
            echo "Found changelog entry for v${VERSION}"
            # Extract section between this version and the next
            sed -n "/## \[${VERSION}\]/,/## \[/p" CHANGELOG.md | head -n -1 | tail -n +2 >> release-notes.txt
            echo "source=changelog" >> "$GITHUB_OUTPUT"
          else
            echo "No CHANGELOG.md entry - generating from commits"
            PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
            echo "### Changes" >> release-notes.txt
            if [[ -n "$PREV_TAG" ]]; then
              git log --pretty=format:"- %s" --no-merges "${PREV_TAG}..HEAD" >> release-notes.txt
            else
              git log --pretty=format:"- %s" --no-merges -20 >> release-notes.txt
            fi
            echo "" >> release-notes.txt
            echo "source=commits" >> "$GITHUB_OUTPUT"
          fi

          echo ""
          echo "=== Generated Release Notes ==="
          cat release-notes.txt
          echo "==============================="

          echo "path=release-notes.txt" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: ${{ steps.changelog.outputs.path }}
          generate_release_notes: false
          prerelease: ${{ contains(github.ref_name, '-') }}
          files: |
            cleo-${{ steps.version.outputs.version }}.tar.gz
            install.sh
            SHA256SUMS
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-npm:
    name: Publish to npm
    runs-on: ubuntu-latest
    needs: release
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '24'
          registry-url: 'https://registry.npmjs.org'

      - run: npm ci

      - run: npm run build

      - name: Verify build output
        run: |
          test -f dist/cli/index.js || { echo "CLI entry missing"; exit 1; }
          test -f dist/mcp/index.js || { echo "MCP entry missing"; exit 1; }
          echo "Build artifacts verified"

      - name: Determine dist-tag
        id: tag
        env:
          REF_NAME: ${{ github.ref_name }}
        run: |
          if [[ "$REF_NAME" == *"-alpha"* ]] || [[ "$REF_NAME" == *"-dev"* ]]; then
            echo "tag=dev" >> $GITHUB_OUTPUT
          elif [[ "$REF_NAME" == *"-beta"* ]] || [[ "$REF_NAME" == *"-rc"* ]]; then
            echo "tag=beta" >> $GITHUB_OUTPUT
          else
            echo "tag=latest" >> $GITHUB_OUTPUT
          fi

      - name: Publish to npm (OIDC Trusted Publishing)
        run: npm publish --tag ${{ steps.tag.outputs.tag }} --access public

  publish-mcp-registry:
    name: Publish to MCP Registry
    runs-on: ubuntu-latest
    needs: publish-npm
    steps:
      - uses: actions/checkout@v4

      - name: Set version in server.json from package.json
        run: |
          VERSION=$(node -p "require('./package.json').version")
          jq --arg v "$VERSION" '.version = $v | .packages[0].version = $v' server.json > server.tmp && mv server.tmp server.json
          echo "Publishing MCP server version: $VERSION"
          cat server.json

      - name: Install mcp-publisher
        run: |
          curl -L "https://github.com/modelcontextprotocol/registry/releases/latest/download/mcp-publisher_$(uname -s | tr '[:upper:]' '[:lower:]')_$(uname -m | sed 's/x86_64/amd64/;s/aarch64/arm64/').tar.gz" | tar xz mcp-publisher

      - name: Authenticate to MCP Registry (OIDC)
        run: ./mcp-publisher login github-oidc

      - name: Publish to MCP Registry
        run: ./mcp-publisher publish
