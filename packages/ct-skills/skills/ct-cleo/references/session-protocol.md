# Session Protocol (Detailed)

Sessions track work context across agent interactions.

## Multi-Session Requirements

**CRITICAL: Multi-session requires BOTH flags:**

```bash
ct session start --scope epic:T001 --auto-focus --name "Name"
#                ^^^^^^^^^^^^^^^^^ REQUIRED     ^^^^^^^^^^^^^ REQUIRED
```

## MCP Session Operations

```
cleo_mutate({ domain: "session", operation: "start",
  params: { scope: "epic:T001", name: "Work", autoStart: true }})
cleo_query({ domain: "session", operation: "status" })
cleo_mutate({ domain: "session", operation: "end", params: { note: "Progress" }})
```

## CLI Session Protocol

### START (ALWAYS first)

```bash
ct session list                # Check existing sessions
ct session status              # Current session
ct session resume <id>         # Resume existing
# OR (only if no suitable session):
ct session start --scope epic:T001 --auto-focus --name "Work"
```

### WORK

```bash
ct focus show                  # Current focus
ct next                        # Task suggestion
ct add "Task" --depends T005   # Add related
ct complete T005               # Complete task
ct focus set T006              # Move focus
```

### END (ALWAYS when stopping)

```bash
ct complete <id>               # Complete current
ct archive                     # Clean up done tasks
ct session end --note "Progress"
```

## Research & Manifest Operations

### Output Requirements

Subagent output files follow this structure:

```markdown
# <Title>

**Task**: T####
**Epic**: T####
**Date**: YYYY-MM-DD
**Status**: complete | partial | blocked

---

## Summary
<2-3 sentence executive summary>

## Content
<main deliverable>
```

### Manifest Entry (MANIFEST.jsonl)

Append ONE line (no pretty-printing):

```json
{"id":"T####-slug","file":"path","title":"...","date":"YYYY-MM-DD","status":"complete","agent_type":"research","topics":[],"key_findings":[],"actionable":true,"needs_followup":[],"linked_tasks":["T####"]}
```

### Status Classification

| Status | Condition | Action |
|--------|-----------|--------|
| `complete` | All objectives achieved | Complete normally |
| `partial` | Some objectives achieved | Populate `needs_followup` |
| `blocked` | Cannot proceed | Document blocker |

## Token System

Orchestrators resolve ALL tokens before spawning subagents. Subagents CANNOT resolve `@` references or `{{TOKEN}}` patterns.

### Standard Tokens

| Token | Description |
|-------|-------------|
| `{{TASK_ID}}` | Current task identifier |
| `{{EPIC_ID}}` | Parent epic identifier |
| `{{DATE}}` | Current date (ISO) |
| `{{TOPIC_SLUG}}` | URL-safe topic name |
| `{{OUTPUT_DIR}}` | Output directory |
| `{{MANIFEST_PATH}}` | Manifest file path |
| `{{TASK_TITLE}}` | Task title |
| `{{TASK_DESCRIPTION}}` | Task description |

### Command Tokens

| Token | Default |
|-------|---------|
| `{{TASK_SHOW_CMD}}` | `cleo show` |
| `{{TASK_FOCUS_CMD}}` | `cleo start` |
| `{{TASK_COMPLETE_CMD}}` | `cleo complete` |
| `{{TASK_LINK_CMD}}` | `cleo research link` |

## Skill Ecosystem

Skills are **context injections, NOT agents**. The orchestrator selects and injects skill content into `cleo-subagent`.

### Discovery

```
cleo_query({ domain: "skills", operation: "list" })
cleo_query({ domain: "skills", operation: "show", params: { name: "ct-orchestrator" }})
```

### Key Skills

| Skill | Category | Use Case |
|-------|----------|----------|
| `ct-orchestrator` | orchestration | Multi-agent coordination |
| `ct-epic-architect` | planning | Epic decomposition |
| `ct-task-executor` | execution | General task execution |
| `ct-research-agent` | research | Information gathering |
| `ct-spec-writer` | specification | Document creation |
| `ct-validator` | validation | Quality checks |
| `ct-documentor` | documentation | Documentation generation |
| `ct-test-writer-bats` | testing | BATS test creation |

### Dispatch Priority

1. **Label-based**: Task labels match skill tags
2. **Catalog-based**: CAAMP dispatch matrix
3. **Type-based**: Task type maps to protocol
4. **Keyword-based**: Title/description matches triggers
5. **Fallback**: `ct-task-executor`

## Release Workflow

**CRITICAL**: `release ship` only commits version metadata. All code changes MUST be committed BEFORE running `release ship`.

```bash
git add <files> && git commit -m "feat(T####): description"
cleo release create v1.0.0
cleo release ship v1.0.0 --bump-version --create-tag --push
```

## Project Context

When available, project-specific configuration is loaded from `.cleo/project-context.json` (generated by `cleo init --detect`). Contains detected project type, testing framework, and LLM hints.
