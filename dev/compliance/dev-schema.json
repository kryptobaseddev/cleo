{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://claude-todo.dev/schemas/v3/dev-schema.json",
  "title": "Dev Scripts Compliance Schema",
  "description": "Validation rules for claude-todo development scripts (dev/) - LLM-Agent-First Spec v3.0 compliant",
  "version": "3.0.0",
  "specVersion": "3.0.0",

  "requirements": {
    "foundation": {
      "libraries": {
        "required": ["dev-common.sh"],
        "optional": ["dev-colors.sh", "dev-exit-codes.sh", "dev-output.sh", "dev-progress.sh"],
        "patterns": {
          "dev_lib_source": "source.*dev-common\\.sh|source.*DEV_LIB_DIR",
          "dual_path": "source.*\\$DEV_LIB_DIR.*\\.sh|if.*-f.*DEV_LIB_DIR"
        }
      },
      "variables": {
        "required": ["SCRIPT_DIR", "DEV_LIB_DIR", "COMMAND_NAME"],
        "optional": ["PROJECT_ROOT", "TOOL_VERSION", "VERSION"],
        "patterns": {
          "script_dir": "SCRIPT_DIR=",
          "dev_lib_dir": "DEV_LIB_DIR=",
          "command_name": "^COMMAND_NAME=",
          "version_central": "VERSION=.*VERSION|TOOL_VERSION="
        }
      }
    },

    "flags": {
      "universal": {
        "required": ["--help", "--format", "--quiet"],
        "shortcuts": ["--json", "--human"],
        "patterns": {
          "help_flag": "-h[|]--help|--help[)]",
          "format_flag": "-f[|]--format|--format[)]",
          "quiet_flag": "-q[|]--quiet|--quiet[)]",
          "json_shortcut": "--json[)]",
          "human_shortcut": "--human[)]",
          "verbose_flag": "-v[|]--verbose|--verbose[)]",
          "dry_run_flag": "--dry-run[)]"
        }
      },
      "write_commands": {
        "required": ["--dry-run"],
        "commands": ["bump-version"]
      },
      "format_resolution": {
        "required": true,
        "pattern": "resolve_format|dev_resolve_format"
      }
    },

    "json_envelope": {
      "required_fields": ["_meta", "success"],
      "meta_fields": ["command", "timestamp", "version"],
      "patterns": {
        "meta_block": "\\\"_meta\\\"",
        "success_field": "\\\"success\\\".*true|\\\"success\\\".*false"
      }
    },

    "exit_codes": {
      "required_constants": true,
      "pattern": "exit.*\\$DEV_EXIT_|DEV_EXIT_",
      "forbidden": "exit [0-9](?!\\})",
      "exit_lib_pattern": "dev-(exit-codes|common|output)\\.sh",
      "exit_lib_name": "dev-exit-codes.sh (via dev-common.sh)"
    },

    "error_handling": {
      "required_function": "log_error|dev_die",
      "defensive_check": "declare -f log_error.*>/dev/null|declare -f dev_die.*>/dev/null",
      "error_codes_pattern": "DEV_EXIT_[A-Z_]+",
      "error_lib_pattern": "dev-(output|common)\\.sh",
      "error_lib_name": "dev-output.sh (via dev-common.sh)",
      "patterns": {
        "log_error": "log_error",
        "dev_die": "dev_die"
      }
    },

    "robustness": {
      "heredoc_safety": {
        "description": "Unquoted heredocs with literal $ must be escaped to avoid set -u errors",
        "safe_patterns": [
          "<<[[:space:]]*'EOF'",
          "<<[[:space:]]*'.*_EOF'",
          "\\\\\\$schema"
        ],
        "unsafe_pattern": "<<[[:space:]]*EOF.*\\$schema[^}]"
      }
    },

    "output": {
      "patterns": {
        "log_info": "log_info",
        "log_step": "log_step"
      }
    }
  },

  "commands": {
    "core": ["bump-version", "validate-version", "check-compliance"],
    "testing": ["benchmark-performance", "test-rollback"],
    "utilities": []
  },

  "commandScripts": {
    "bump-version": "bump-version.sh",
    "validate-version": "validate-version.sh",
    "check-compliance": "check-compliance.sh",
    "benchmark-performance": "benchmark-performance.sh",
    "test-rollback": "test-rollback.sh"
  },

  "scoring": {
    "foundation_libs": 10,
    "dual_path": 5,
    "command_name": 5,
    "version_central": 5,
    "format_flag": 10,
    "quiet_flag": 5,
    "json_shortcut": 5,
    "human_shortcut": 5,
    "resolve_format": 10,
    "meta_block": 5,
    "success_field": 5,
    "exit_constants": 10,
    "exit_lib_sourced": 5,
    "log_error": 5,
    "error_lib_sourced": 5,
    "dry_run": 5
  },

  "thresholds": {
    "pass": 95,
    "warn": 80,
    "fail": 0
  },

  "notes": {
    "description": "Dev scripts follow LLM-Agent-First principles like main scripts",
    "requirements": [
      "JSON output by default for non-TTY (agent automation)",
      "Structured _meta envelope with command, timestamp, version",
      "Format flags: --format, --quiet, --json, --human",
      "Exit code constants: DEV_EXIT_* from dev/lib/dev-exit-codes.sh",
      "Error functions: log_error/dev_die from dev/lib/dev-output.sh"
    ],
    "library_mapping": {
      "main_lib": "dev_lib",
      "exit-codes.sh": "dev-exit-codes.sh",
      "error-json.sh": "dev-output.sh (log_error)",
      "output-format.sh": "dev-common.sh (dev_resolve_format)",
      "EXIT_*": "DEV_EXIT_*",
      "output_error()": "log_error() or dev_die()"
    }
  }
}
