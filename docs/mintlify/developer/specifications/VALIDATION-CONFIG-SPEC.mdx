---
title: "Project-Agnostic Configuration System"
description: "RFC 2119 specification for project-agnostic validation and testing configuration"
version: "1.0.0"
status: "draft"
created: "2026-01-29"
epic: "T2741"
task: "T2760"
---

# Project-Agnostic Configuration System Specification

## 1. Overview

### 1.1 Purpose

This specification defines a project-agnostic configuration system that eliminates hardcoded assumptions about testing frameworks, directories, tools, and language runtimes from CLEO. The system enables CLEO to work seamlessly across Node.js, Python, Rust, Go, and other ecosystems through automatic project detection and configurable validation.

### 1.2 Scope

This specification covers:
- Configuration schema for 8 core sections (testing, directories, tools, files, output, vcs, platform, language)
- Project detection system via `cleo init --detect`
- LLM agent integration through `project-context.json`
- Configuration inheritance via `extends` pattern
- Backward compatibility guarantees
- Migration path from hardcoded assumptions

This specification does NOT cover:
- Task schema or todo.json structure (see todo.schema.json)
- Session management (see SESSION-MANAGEMENT-SPEC.mdx)
- Archive policies (see config.schema.json archive section)

### 1.3 Goals

**Primary Goals:**
1. **Zero Breaking Changes**: Existing BATS projects continue working without modification
2. **Multi-Framework Support**: Support 16+ testing frameworks across major ecosystems
3. **Automatic Detection**: `cleo init --detect` discovers project configuration
4. **LLM Agent First**: Structured metadata optimized for agent @ injection
5. **Graceful Degradation**: Detection succeeds even when uncertain

**Non-Goals:**
- Full language runtime detection (focus on validation/testing only)
- Build system integration (out of scope)
- IDE/editor integration (future enhancement)

---

## 2. Terminology (RFC 2119)

The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in [RFC 2119](https://www.rfc-editor.org/rfc/rfc2119.html).

Additional terminology:
- **Project Root**: Directory containing `.cleo/` data directory
- **Manifest File**: package.json, Cargo.toml, go.mod, pyproject.toml, etc.
- **Detection Tier**: Level of confidence in detection (Tier 1 = high, Tier 3 = low)
- **Shareable Config**: Configuration published as npm package or file path
- **Schema Version**: Semantic version string tracking config schema evolution

---

## 3. Configuration Schema

### 3.1 Top-Level Structure

Implementations MUST support a configuration file at `.cleo/config.json` with the following structure:

```json
{
  "$schema": "https://cleo-dev.com/schemas/v2/config.schema.json",
  "_meta": {
    "schemaVersion": "2.0.0"
  },
  "extends": "~/.cleo/config.json",
  "validation": { "testing": {...} },
  "testing": {...},
  "directories": {...},
  "tools": {...},
  "files": {...},
  "output": {...},
  "vcs": {...},
  "platform": {...},
  "language": {...}
}
```

**REQUIRED top-level fields:**
- `_meta.schemaVersion`: Semantic version string (pattern: `^\d+\.\d+\.\d+$`)

**OPTIONAL top-level fields:**
- `$schema`: JSON Schema reference URI for validation
- `extends`: Configuration inheritance (string or array of strings)
- All 8 config sections (validation, testing, directories, tools, files, output, vcs, platform, language)

### 3.2 Section: validation.testing (Legacy)

This section MUST be preserved for backward compatibility with existing CLEO installations. New fields SHOULD be added to the `testing` section instead.

**Schema:**

```json
{
  "validation": {
    "testing": {
      "enabled": true,
      "framework": "bats",
      "command": "./tests/run-all-tests.sh",
      "directory": "tests",
      "requirePassingTests": false,
      "runOnComplete": false,
      "testFilePatterns": ["**/*.bats"]
    }
  }
}
```

**Field Requirements:**

| Field | Type | MUST/SHOULD | Default | Description |
|-------|------|-------------|---------|-------------|
| `enabled` | boolean | OPTIONAL | `true` | Enable test validation |
| `framework` | enum[16] | SHOULD | `"bats"` | Testing framework identifier |
| `command` | string | MUST | (framework-specific) | Test execution command |
| `directory` | string | SHOULD | `"tests"` | Test directory relative to project root |
| `requirePassingTests` | boolean | OPTIONAL | `false` | Block operations on test failure |
| `runOnComplete` | boolean | OPTIONAL | `false` | Auto-run tests on task completion |
| `testFilePatterns` | array | SHOULD | `["**/*.bats"]` | Glob patterns for test files |

**Framework Enum** (REQUIRED):

Implementations MUST support the following 16 framework identifiers:

```json
["bats", "jest", "vitest", "playwright", "cypress", "mocha", "ava", "uvu", "tap", "node:test", "deno", "bun", "pytest", "go", "cargo", "custom"]
```

**Framework Coverage:**
- **JavaScript/TypeScript** (7): jest, vitest, playwright, cypress, mocha, ava, uvu, tap
- **Runtime Built-ins** (3): node:test, deno, bun
- **Python** (1): pytest
- **Rust** (1): cargo
- **Go** (1): go
- **Custom** (1): Fallback for unsupported frameworks

Implementations SHOULD use `"custom"` for frameworks not in the enum and SHOULD emit a warning suggesting the framework be added to the specification.

### 3.3 Section: testing (Comprehensive)

This section provides comprehensive testing configuration beyond validation gates. Implementations SHOULD use this section for new features.

**Schema:**

```json
{
  "testing": {
    "framework": {
      "name": "bats",
      "fileExtension": ".bats",
      "installCommand": "npm install -g bats",
      "runCommand": "./tests/run-all-tests.sh",
      "watchCommand": null,
      "coverageCommand": null,
      "configFile": null
    },
    "directories": {
      "unit": "tests/unit/",
      "integration": "tests/integration/",
      "golden": "tests/golden/",
      "fixtures": "tests/fixtures/"
    },
    "skillName": "ct-test-writer-bats",
    "dispatchKeywords": ["test", "bats", "coverage", "testing"],
    "tempPathPattern": "/bats-run-|/test/.*test-"
  }
}
```

**Field Requirements:**

| Field | Type | MUST/SHOULD | Description |
|-------|------|-------------|-------------|
| `framework.name` | enum[16] | MUST | Framework identifier (same enum as validation.testing.framework) |
| `framework.fileExtension` | string | SHOULD | Test file extension (e.g., `.bats`, `.test.ts`) |
| `framework.installCommand` | string | MAY | Command to install framework |
| `framework.runCommand` | string | MUST | Command to execute tests |
| `framework.watchCommand` | string\|null | MAY | Command for watch mode (null if unsupported) |
| `framework.coverageCommand` | string\|null | MAY | Command for coverage reports (null if unsupported) |
| `framework.configFile` | string\|null | MAY | Framework config file path (null if none) |
| `directories.unit` | string | SHOULD | Unit test directory |
| `directories.integration` | string | SHOULD | Integration test directory |
| `directories.golden` | string | MAY | Golden test directory |
| `directories.fixtures` | string | SHOULD | Test fixtures directory |
| `skillName` | string | MAY | CLEO skill for test generation |
| `dispatchKeywords` | array | MAY | Keywords for skill auto-dispatch |
| `tempPathPattern` | string | MAY | Regex pattern for temp test files (context window management) |

**Framework-Specific Defaults:**

Implementations SHOULD provide framework-specific defaults for common configurations:

| Framework | fileExtension | runCommand | watchCommand | coverageCommand |
|-----------|---------------|------------|--------------|-----------------|
| `bats` | `.bats` | `./tests/run-all-tests.sh` | null | null |
| `jest` | `.test.js` | `jest` | `jest --watch` | `jest --coverage` |
| `vitest` | `.test.ts` | `vitest run` | `vitest` | `vitest --coverage` |
| `playwright` | `.spec.ts` | `playwright test` | `playwright test --ui` | null |
| `pytest` | `_test.py` | `pytest` | `pytest-watch` | `pytest --cov` |
| `go` | `_test.go` | `go test ./...` | `go test -watch ./...` | `go test -cover ./...` |
| `cargo` | `.rs` | `cargo test` | `cargo watch -x test` | `cargo tarpaulin` |

### 3.4 Section: directories

This section defines all directory path assumptions. Implementations MUST read from this section instead of hardcoding paths.

**Schema:**

```json
{
  "directories": {
    "data": ".cleo",
    "schemas": "schemas",
    "backups": {
      "root": "backups",
      "types": ["snapshot", "safety", "incremental", "archive", "migration"]
    },
    "templates": "templates",
    "research": {
      "output": "research",
      "archive": "research/archive"
    },
    "agentOutputs": ".cleo/agent-outputs",
    "metrics": "claudedocs/metrics",
    "documentation": "docs",
    "skills": "skills",
    "sync": "sync"
  }
}
```

**Field Requirements:**

| Field | Type | MUST/SHOULD | Default | Description |
|-------|------|-------------|---------|-------------|
| `data` | string | MUST | `.cleo` | CLEO data directory (contains todo.json, config.json) |
| `schemas` | string | SHOULD | `schemas` | JSON Schema definitions |
| `backups.root` | string | SHOULD | `backups` | Backup storage root |
| `backups.types` | array | MAY | (5 types) | Backup type subdirectories |
| `templates` | string | SHOULD | `templates` | Template storage |
| `research.output` | string | SHOULD | `research` | Research output directory |
| `research.archive` | string | MAY | `research/archive` | Archived research |
| `agentOutputs` | string | MUST | `.cleo/agent-outputs` | Agent manifest outputs |
| `metrics` | string | MAY | `claudedocs/metrics` | Metrics collection |
| `documentation` | string | SHOULD | `docs` | User-facing documentation |
| `skills` | string | MAY | `skills` | CLEO skill definitions |
| `sync` | string | MAY | `sync` | TodoWrite sync directory |

**Constraint**: All paths MUST be relative to project root. Absolute paths MUST be rejected with validation error.

### 3.5 Section: tools

This section defines external tool dependencies and installation commands.

**Schema:**

```json
{
  "tools": {
    "jsonProcessor": {
      "name": "jq",
      "command": "jq",
      "installCommand": "brew install jq",
      "required": true
    },
    "schemaValidator": {
      "name": "ajv-cli",
      "command": "ajv",
      "installCommand": "npm install -g ajv-cli",
      "required": false
    },
    "testRunner": {
      "name": "bats",
      "command": "bats",
      "installCommand": "npm install -g bats",
      "required": true
    },
    "linter": {
      "bash": {
        "name": "shellcheck",
        "command": "shellcheck",
        "installCommand": "brew install shellcheck",
        "required": false
      }
    }
  }
}
```

**Field Requirements:**

| Field | Type | MUST/SHOULD | Description |
|-------|------|-------------|-------------|
| `<tool>.name` | string | MUST | Human-readable tool name |
| `<tool>.command` | string | MUST | Command name for execution |
| `<tool>.installCommand` | string | SHOULD | Installation command (platform-specific) |
| `<tool>.required` | boolean | MUST | Whether tool is required for CLEO operation |

**Standard Tools** (MUST be supported):
- `jsonProcessor`: JSON manipulation (default: jq)
- `schemaValidator`: JSON Schema validation (default: ajv-cli)
- `testRunner`: Test execution (framework-specific)

**Optional Tools** (MAY be supported):
- `linter.<language>`: Language-specific linting
- `formatter.<language>`: Code formatting
- `packageManager`: npm, yarn, pnpm, cargo, pip, etc.

### 3.6 Section: files

This section defines file pattern assumptions for validation and discovery.

**Schema:**

```json
{
  "files": {
    "supportedExtensions": [".sh", ".json", ".md", ".bats", ".yaml", ".yml", ".ts", ".js", ".py"],
    "patterns": {
      "scripts": "*.sh",
      "backups": "*.json",
      "documentation": "*.md",
      "skills": "*.md",
      "sessions": "context-state-*.json"
    }
  }
}
```

**Field Requirements:**

| Field | Type | MUST/SHOULD | Description |
|-------|------|-------------|-------------|
| `supportedExtensions` | array | SHOULD | File extensions CLEO can process |
| `patterns.<type>` | string | MAY | Glob pattern for file type |

Implementations SHOULD use these patterns for:
- File validation (reject unsupported extensions)
- Discovery operations (glob matching)
- Context window calculations (estimate token counts)

### 3.7 Section: output

This section defines output formatting preferences.

**Schema:**

```json
{
  "output": {
    "autoDetect": true,
    "defaultFormat": "json",
    "ttyFormat": "text",
    "errorFormat": "json",
    "colorSupport": true
  }
}
```

**Field Requirements:**

| Field | Type | MUST/SHOULD | Default | Description |
|-------|------|-------------|---------|-------------|
| `autoDetect` | boolean | SHOULD | `true` | Auto-detect TTY vs pipe |
| `defaultFormat` | enum | MUST | `"json"` | Default output format (json, text, table) |
| `ttyFormat` | enum | SHOULD | `"text"` | Format when TTY detected |
| `errorFormat` | enum | MUST | `"json"` | Error message format |
| `colorSupport` | boolean | SHOULD | `true` | Enable ANSI colors (respects NO_COLOR env var) |

**Format Enum**: `["json", "text", "table", "markdown", "csv"]`

### 3.8 Section: vcs

This section defines version control system integration.

**Schema:**

```json
{
  "vcs": {
    "type": "git",
    "hooks": {
      "enabled": true,
      "commitMsg": ".cleo/templates/git-hooks/commit-msg"
    },
    "ignore": ["claudedocs/", ".cleo/backups/"]
  }
}
```

**Field Requirements:**

| Field | Type | MUST/SHOULD | Default | Description |
|-------|------|-------------|---------|-------------|
| `type` | enum | SHOULD | `"git"` | VCS type (git, hg, svn) |
| `hooks.enabled` | boolean | MAY | `true` | Enable hook installation |
| `hooks.commitMsg` | string | MAY | (path) | Commit message hook template |
| `ignore` | array | SHOULD | (paths) | Directories to add to .gitignore |

### 3.9 Section: platform

This section defines platform-specific paths and package manager integration.

**Schema:**

```json
{
  "platform": {
    "packageManagers": {
      "homebrew": {
        "paths": [
          "/opt/homebrew/bin/bash",
          "/usr/local/bin/bash",
          "/home/linuxbrew/.linuxbrew/bin/bash"
        ]
      }
    }
  }
}
```

**Field Requirements:**

| Field | Type | MUST/SHOULD | Description |
|-------|------|-------------|-------------|
| `packageManagers.<name>.paths` | array | MAY | Search paths for binaries |

### 3.10 Section: language

This section defines language runtime and style preferences.

**Schema:**

```json
{
  "language": {
    "name": "bash",
    "runtime": "/usr/bin/env bash",
    "version": "4.0+",
    "errorHandling": "set -euo pipefail",
    "features": ["associative-arrays", "process-substitution", "pipefail"],
    "style": {
      "indent": 4,
      "case": "snake_case",
      "constants": "UPPER_SNAKE_CASE"
    }
  }
}
```

**Field Requirements:**

| Field | Type | MUST/SHOULD | Default | Description |
|-------|------|-------------|---------|-------------|
| `name` | string | SHOULD | `"bash"` | Language identifier |
| `runtime` | string | SHOULD | (shebang) | Runtime path or env resolution |
| `version` | string | MAY | (version constraint) | Minimum version requirement |
| `errorHandling` | string | MAY | (language-specific) | Error handling pattern |
| `features` | array | MAY | (feature list) | Required language features |
| `style.indent` | integer | MAY | `4` | Indentation spaces |
| `style.case` | enum | MAY | `"snake_case"` | Naming convention |
| `style.constants` | enum | MAY | `"UPPER_SNAKE_CASE"` | Constant naming |

### 3.11 Section: extends

Configuration inheritance enables shareable configs and reduces duplication.

**Schema:**

```json
{
  "extends": "~/.cleo/config.json"
}
```

or

```json
{
  "extends": [
    "~/.cleo/config.json",
    "@cleo/config-ci"
  ]
}
```

**Type**: `string | string[]`

**Resolution Order** (left-to-right, last wins):
1. Load global config (`~/.cleo/config.json`)
2. Load each extended config in array order
3. Deep merge project config
4. Apply environment variable overrides

**Supported Formats:**
- **File path**: `~/.cleo/config.json`, `../shared/config.json`
- **npm package**: `@cleo/config-ci`, `cleo-config-python`

**Deep Merge Strategy:**

Implementations MUST use deep merge with the following rules:
- Primitive values (string, number, boolean): Last value wins
- Arrays: Concatenate (preserving order, removing duplicates)
- Objects: Recursively merge keys

**Example:**

Base config:
```json
{
  "validation": {
    "testing": {
      "framework": "bats",
      "enabled": true
    }
  }
}
```

Extended config:
```json
{
  "extends": "base.json",
  "validation": {
    "testing": {
      "framework": "vitest"
    }
  }
}
```

Result:
```json
{
  "validation": {
    "testing": {
      "framework": "vitest",
      "enabled": true
    }
  }
}
```

**Circular Dependency Detection:**

Implementations MUST detect circular extends chains and MUST fail with error exit code 6 (E_VALIDATION_FAILED).

---

## 4. Project Detection (cleo init --detect)

### 4.1 Detection Pipeline

Implementations MUST support a 3-tier detection system for automatic project configuration:

**Tier 1: Manifest Files** (Highest Confidence)
- package.json (Node.js)
- Cargo.toml (Rust)
- go.mod (Go)
- pyproject.toml (Python)
- composer.json (PHP)
- Gemfile (Ruby)

**Tier 2: Dependency Scanning** (Medium Confidence)
- devDependencies in package.json
- [dev-dependencies] in Cargo.toml
- [tool.*] sections in pyproject.toml

**Tier 3: Script Analysis** (Low Confidence)
- Parse test scripts in package.json
- Analyze import statements in test files
- Check for framework-specific config files

### 4.2 Detection Algorithm

Implementations MUST follow this detection sequence:

```
1. IF manifest file exists:
     a. Identify project type from manifest (node, rust, go, python, etc.)
     b. Scan dependencies for test framework
     c. Parse test scripts for framework commands
     d. Return detection result with confidence level

2. ELSE IF test framework config exists (e.g., jest.config.js):
     a. Infer framework from config filename
     b. Infer project type from framework
     c. Return detection result with MEDIUM confidence

3. ELSE IF test files exist:
     a. Analyze file extensions and imports
     b. Return detection result with LOW confidence

4. ELSE:
     a. Return "unknown" project type
     b. Emit warning suggesting manual configuration
     c. Use BATS defaults for backward compatibility
```

### 4.3 Confidence Levels

Detection results MUST include confidence level:

| Level | Criteria | Action |
|-------|----------|--------|
| `HIGH` | Manifest file + dependency match | Write config without confirmation |
| `MEDIUM` | Config file or script analysis match | Prompt for confirmation |
| `LOW` | File extension heuristics only | Prompt with warnings |
| `UNKNOWN` | No detection signals | Use BATS defaults, emit warning |

### 4.4 Multi-Framework Projects

When multiple frameworks are detected (e.g., jest + playwright), implementations SHOULD:

1. Prompt user to select primary framework
2. Configure all detected frameworks in separate sections
3. Set primary framework in `validation.testing.framework`

**Priority Order for Auto-Selection:**
- Node.js: vitest > jest > playwright > mocha > ava
- Python: pytest
- Rust: cargo
- Go: go

### 4.5 Monorepo Detection

Implementations MUST detect monorepos via:
- `workspaces` field in package.json
- `pnpm-workspace.yaml` existence
- `lerna.json` existence
- `[workspace]` section in Cargo.toml

When monorepo detected, implementations SHOULD:
1. Warn that configuration may need per-package customization
2. Generate root-level config with common framework
3. Document how to override per package

### 4.6 Detection Output

The `cleo init --detect` command MUST:
1. Write `.cleo/config.json` with detected values
2. Write `.cleo/project-context.json` with metadata (see §5)
3. Return JSON output with detection results

**Output Format:**

```json
{
  "success": true,
  "projectType": "node",
  "framework": "vitest",
  "confidence": "HIGH",
  "detectedFrom": "package.json devDependencies",
  "warnings": [],
  "suggestedActions": [
    "Review generated config at .cleo/config.json",
    "Run cleo validate to verify setup"
  ]
}
```

### 4.7 Flags

Implementations MUST support:

| Flag | Type | Description |
|------|------|-------------|
| `--detect` | boolean | Enable auto-detection (default: false) |
| `--confirm` | boolean | Prompt for confirmation (default: true when MEDIUM/LOW confidence) |
| `--dry-run` | boolean | Show detection results without writing files |
| `--force` | boolean | Overwrite existing config without confirmation |

---

## 5. LLM Agent Integration (project-context.json)

### 5.1 Purpose

The `project-context.json` file provides structured metadata optimized for LLM agent consumption via @ reference injection. This file is GENERATED, not hand-edited.

**Key Distinction:**
- `config.json` = **Executable configuration** (commands, paths, validation rules)
- `project-context.json` = **Discovery metadata** (detected conventions, LLM guidance)

### 5.2 Schema

```json
{
  "$schema": "https://cleo-dev.com/schemas/v1/project-context.schema.json",
  "schemaVersion": "1.0.0",
  "detectedAt": "2026-01-29T12:00:00Z",
  "projectTypes": ["node"],
  "primaryType": "node",
  "monorepo": false,
  "testing": {
    "framework": "vitest",
    "command": "vitest",
    "testFilePatterns": ["**/*.test.ts"],
    "directories": {
      "unit": "tests/unit",
      "integration": "tests/integration"
    }
  },
  "build": {
    "command": "npm run build",
    "outputDir": "dist"
  },
  "directories": {
    "source": "src",
    "tests": "tests",
    "docs": "docs"
  },
  "conventions": {
    "fileNaming": "kebab-case",
    "importStyle": "esm",
    "typeSystem": "typescript"
  },
  "llmHints": {
    "preferredTestStyle": "vitest with describe/it blocks",
    "typeSystem": "TypeScript strict mode",
    "commonPatterns": [
      "Use async/await over promises",
      "Export types separately from implementation"
    ],
    "avoidPatterns": [
      "Don't use require() - this is an ESM project",
      "Don't use any type - strict mode enabled"
    ]
  }
}
```

### 5.3 Field Requirements

| Field | Type | MUST/SHOULD | Description |
|-------|------|-------------|-------------|
| `schemaVersion` | string | MUST | Project context schema version |
| `detectedAt` | string | MUST | ISO 8601 timestamp of detection |
| `projectTypes` | array | MUST | All detected project types |
| `primaryType` | string | SHOULD | Primary project type |
| `monorepo` | boolean | SHOULD | Whether project is a monorepo |
| `testing.*` | object | SHOULD | Testing configuration summary |
| `build.*` | object | MAY | Build configuration summary |
| `directories.*` | object | SHOULD | Directory structure summary |
| `conventions.*` | object | MAY | Coding conventions |
| `llmHints.*` | object | SHOULD | LLM agent guidance |

### 5.4 LLM Hints Section

The `llmHints` object provides framework-specific guidance for LLM agents:

**preferredTestStyle** (string):
- vitest: "vitest with describe/it blocks"
- jest: "jest with describe/test blocks"
- pytest: "pytest with test_ prefix functions"
- go: "go test with TestXxx functions"

**typeSystem** (string):
- TypeScript projects: "TypeScript strict mode" or "TypeScript with type: module"
- Python projects: "Python with type hints" or "Python 3.10+ match/case"
- Rust projects: "Rust with strict clippy"

**commonPatterns** (array of strings):
- Framework-specific best practices
- Project-specific conventions
- Preferred async patterns

**avoidPatterns** (array of strings):
- Deprecated APIs
- Incompatible syntax (e.g., CommonJS in ESM project)
- Style violations

### 5.5 CLAUDE.md Injection

Implementations SHOULD generate or update CLAUDE.md with:

```markdown
## Project Context (Auto-Detected)

@.cleo/project-context.json
```

This enables agents to read structured project metadata via @ reference.

### 5.6 Regeneration

The `project-context.json` file SHOULD be regenerated when:
- `cleo init --detect` runs
- Manifest file (package.json, Cargo.toml, etc.) changes significantly
- Test framework dependencies change

Implementations MAY add `cleo context refresh` command for manual regeneration.

---

## 6. Backward Compatibility

### 6.1 Guarantees

Implementations MUST preserve the following behaviors:

**BATS Projects (Existing):**
- Projects without `validation.testing` in config.json MUST use schema defaults (BATS)
- Test execution MUST work identically to pre-v2.0 behavior
- No migration required for existing projects

**Schema Defaults:**
- `validation.testing.framework`: `"bats"`
- `validation.testing.directory`: `"tests"`
- `validation.testing.testFilePatterns`: `["**/*.bats"]`
- `validation.testing.command`: `"./tests/run-all-tests.sh"`

**Validation:**
- All existing JSON Schema validations MUST continue working
- Exit codes MUST remain unchanged
- Error messages MUST remain machine-readable

### 6.2 Deprecation Strategy

The following elements are DEPRECATED but MUST be supported:

| Deprecated | Replacement | Timeline |
|------------|-------------|----------|
| Hardcoded BATS paths in lib/ | config.directories | v2.0-v3.0 |
| Hardcoded jq tool paths | config.tools.jsonProcessor | v2.0-v3.0 |
| `version` field (root) | `_meta.schemaVersion` | v2.0-v3.0 |

**Deprecation Warnings:**

Implementations SHOULD emit warnings when:
- Code reads hardcoded path instead of config value
- Legacy `version` field used instead of `_meta.schemaVersion`
- Missing config section with available default

**Warning Format:**

```json
{
  "warning": {
    "code": "W_DEPRECATED_HARDCODED_PATH",
    "message": "Using hardcoded path 'tests/' - consider setting config.directories.testing",
    "fix": "Add 'directories.testing' to .cleo/config.json",
    "silenceUntil": "3.0.0"
  }
}
```

### 6.3 Migration Path

**Phase 1** (v2.0): Add new config sections with BATS defaults
- Schema updated with 8 sections
- Code reads from config with fallback to hardcoded values
- `cleo init --detect` available for new projects

**Phase 2** (v2.1-v2.5): Update code to prefer config over hardcoded
- Deprecation warnings emitted
- `cleo config migrate` command added
- Detection system improved based on feedback

**Phase 3** (v2.6-v2.9): Soft enforcement
- Warnings become errors in strict mode (`config.validation.strictMode: true`)
- Migration guide in CHANGELOG.md
- Automated migration script available

**Phase 4** (v3.0): Remove hardcoded values
- Major version bump (breaking change)
- All code reads from config (no fallbacks)
- `cleo config migrate` required before upgrade

---

## 7. Schema Version Management

### 7.1 Versioning Strategy

Config schema MUST use semantic versioning:
- **MAJOR**: Breaking changes (field removal, type changes)
- **MINOR**: Non-breaking additions (new optional fields)
- **PATCH**: Documentation fixes, clarifications

### 7.2 Schema Version Field

The canonical schema version MUST be stored in `_meta.schemaVersion`:

```json
{
  "_meta": {
    "schemaVersion": "2.6.0"
  }
}
```

The legacy `version` field MAY be preserved for backward compatibility but SHOULD emit deprecation warning.

### 7.3 Migration Functions

Implementations MUST provide migration functions for each MINOR/MAJOR version:

**Naming Convention:**
- `migrate_config_to_<major>_<minor>_<patch>`
- Example: `migrate_config_to_2_6_0`

**Discovery:**
- Migrations discovered via `lib/migrate.sh::discover_migration_versions()`
- No hardcoded version constants allowed

**Migration Script:**

```bash
cleo config migrate [--from VERSION] [--to VERSION] [--dry-run]
```

**Output:**

```json
{
  "success": true,
  "migratedFrom": "2.5.0",
  "migratedTo": "2.6.0",
  "changes": [
    "Added contextAlerts section",
    "Added lifecycleEnforcement.mode field"
  ],
  "backupPath": ".cleo/backups/migration/config-2.5.0.json"
}
```

### 7.4 Version Detection

Implementations MUST read schema version using `lib/migrate.sh::get_schema_version_from_file()`:

```bash
source lib/migrate.sh
version=$(get_schema_version_from_file "config")
# Returns "2.6.0"
```

**Search Order:**
1. `_meta.schemaVersion` (canonical)
2. `version` (legacy fallback)
3. Schema file `schemaVersion` field

---

## 8. Conformance

### 8.1 MUST Requirements

An implementation conforms to this specification if it:

1. Supports all 8 config sections (validation, testing, directories, tools, files, output, vcs, platform, language)
2. Supports all 16 testing frameworks in enum
3. Validates config against JSON Schema
4. Preserves BATS defaults for backward compatibility
5. Implements 3-tier project detection
6. Generates project-context.json on `cleo init --detect`
7. Supports `extends` with deep merge
8. Uses `_meta.schemaVersion` for version tracking
9. Emits deprecation warnings for hardcoded paths
10. Provides migration functions for schema upgrades

### 8.2 SHOULD Requirements

A high-quality implementation SHOULD:

1. Auto-detect testing framework with HIGH confidence for major ecosystems
2. Prompt for confirmation on MEDIUM/LOW confidence detection
3. Generate framework-specific LLM hints in project-context.json
4. Support shareable configs via npm packages
5. Detect monorepos and warn about per-package configuration
6. Provide `cleo config migrate` command
7. Update CLAUDE.md with project-context.json @ reference
8. Clean up orphaned config sections on migration

### 8.3 MAY Requirements

An implementation MAY:

1. Support additional testing frameworks beyond the 16 enum values
2. Cache detection results for performance
3. Provide IDE/editor integration for config validation
4. Support environment variable overrides for all config fields
5. Generate config templates for common project types
6. Validate tool availability on `cleo doctor`

### 8.4 Test Suite

Implementations MUST pass the following test scenarios:

**Backward Compatibility:**
- ✅ BATS project without config works identically to v1.x
- ✅ Existing config.json validates against v2.x schema
- ✅ Schema defaults match v1.x hardcoded values

**Detection:**
- ✅ Node.js project with jest detected as HIGH confidence
- ✅ Python project with pytest detected as HIGH confidence
- ✅ Rust project with cargo detected as HIGH confidence
- ✅ Unknown project type defaults to BATS with warning

**Configuration:**
- ✅ Extended config deep merges correctly
- ✅ Circular extends chain detected and rejected
- ✅ Framework-specific defaults applied correctly

**Migration:**
- ✅ v1.x config migrates to v2.x without data loss
- ✅ Deprecation warnings emitted for hardcoded paths
- ✅ Schema version updates correctly

---

## 9. Examples

### 9.1 Node.js Vitest Project

**Detected config.json:**

```json
{
  "$schema": "https://cleo-dev.com/schemas/v2/config.schema.json",
  "_meta": {
    "schemaVersion": "2.0.0"
  },
  "validation": {
    "testing": {
      "enabled": true,
      "framework": "vitest",
      "command": "vitest run",
      "directory": "tests",
      "testFilePatterns": ["**/*.test.ts"]
    }
  },
  "testing": {
    "framework": {
      "name": "vitest",
      "fileExtension": ".test.ts",
      "runCommand": "vitest run",
      "watchCommand": "vitest",
      "coverageCommand": "vitest --coverage"
    }
  }
}
```

**Generated project-context.json:**

```json
{
  "schemaVersion": "1.0.0",
  "detectedAt": "2026-01-29T12:00:00Z",
  "projectTypes": ["node"],
  "primaryType": "node",
  "testing": {
    "framework": "vitest",
    "command": "vitest run"
  },
  "llmHints": {
    "preferredTestStyle": "vitest with describe/it blocks",
    "typeSystem": "TypeScript strict mode"
  }
}
```

### 9.2 Python Pytest Project

**Detected config.json:**

```json
{
  "_meta": {
    "schemaVersion": "2.0.0"
  },
  "validation": {
    "testing": {
      "framework": "pytest",
      "command": "pytest",
      "directory": "tests",
      "testFilePatterns": ["**/*_test.py", "**/test_*.py"]
    }
  },
  "language": {
    "name": "python",
    "runtime": "/usr/bin/env python3",
    "version": "3.8+"
  }
}
```

### 9.3 Rust Cargo Project

**Detected config.json:**

```json
{
  "_meta": {
    "schemaVersion": "2.0.0"
  },
  "validation": {
    "testing": {
      "framework": "cargo",
      "command": "cargo test",
      "directory": "tests",
      "testFilePatterns": ["**/*.rs"]
    }
  },
  "tools": {
    "testRunner": {
      "name": "cargo",
      "command": "cargo",
      "installCommand": "curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh"
    }
  }
}
```

### 9.4 Shareable Config Example

**@cleo/config-ci package:**

```json
{
  "_meta": {
    "schemaVersion": "2.0.0"
  },
  "validation": {
    "testing": {
      "requirePassingTests": true,
      "runOnComplete": true
    }
  },
  "output": {
    "defaultFormat": "json",
    "colorSupport": false
  }
}
```

**Project using shareable config:**

```json
{
  "extends": ["~/.cleo/config.json", "@cleo/config-ci"],
  "validation": {
    "testing": {
      "framework": "vitest"
    }
  }
}
```

**Result after merge:**

```json
{
  "validation": {
    "testing": {
      "framework": "vitest",
      "requirePassingTests": true,
      "runOnComplete": true
    }
  },
  "output": {
    "defaultFormat": "json",
    "colorSupport": false
  }
}
```

---

## 10. Security Considerations

### 10.1 Command Injection

Config fields containing shell commands (e.g., `testing.framework.runCommand`) MUST be properly escaped before execution. Implementations MUST NOT use `eval` or unquoted variable expansion.

**Safe execution pattern:**

```bash
test_command=$(jq -r '.validation.testing.command' .cleo/config.json)
# SAFE: Command stored in variable, properly quoted
"$test_command"

# UNSAFE: eval allows injection
eval "$test_command"
```

### 10.2 Path Traversal

Config fields containing file paths MUST be validated to prevent directory traversal attacks:
- Reject absolute paths (except for extends resolution)
- Reject `..` segments in relative paths
- Canonicalize paths before use

### 10.3 Extends Chain Limits

Implementations MUST limit extends chain depth to prevent:
- Infinite recursion (circular dependencies)
- Resource exhaustion (deep chains)

**Recommended limit**: 10 levels

### 10.4 npm Package Resolution

When resolving npm packages in `extends`, implementations SHOULD:
- Verify package signature/integrity
- Use package-lock.json or equivalent
- Warn when loading unverified configs

---

## 11. References

- **RFC 2119**: Key words for use in RFCs to Indicate Requirement Levels
- **Epic**: T2741 (Project-Agnostic Validation & Testing Config System)
- **Consensus**: T2759 (Unified Config Schema Design Consensus)
- **Input Documents**:
  - T2754: Modern Testing Frameworks Survey
  - T2755: Hardcoded Assumptions Deep Audit (171+ items)
  - T2756: Project Onboarding Init System Design
  - T2758: Config Schema Modernization Patterns
- **Related Specifications**:
  - `schemas/config.schema.json` (v2.6.0)
  - `schemas/project-context.schema.json` (v1.0.0)
  - `docs/developer/specifications/TASK-HIERARCHY.mdx`

---

## Appendix A: Framework Detection Patterns

| Framework | Manifest Field | Config File | File Pattern |
|-----------|----------------|-------------|--------------|
| jest | devDependencies.jest | jest.config.js | *.test.js |
| vitest | devDependencies.vitest | vitest.config.ts | *.test.ts |
| playwright | devDependencies.@playwright/test | playwright.config.ts | *.spec.ts |
| pytest | [tool.poetry.dev-dependencies].pytest | pytest.ini | test_*.py |
| cargo | [dev-dependencies] (in Cargo.toml) | Cargo.toml | tests/*.rs |
| go | go.mod (testing stdlib) | - | *_test.go |

---

## Appendix B: Migration Checklist

**Pre-Migration:**
- [ ] Backup .cleo/config.json (Tier 2 safety backup)
- [ ] Run `cleo validate` to ensure current config is valid
- [ ] Review CHANGELOG.md for breaking changes

**Migration:**
- [ ] Run `cleo config migrate --dry-run` to preview changes
- [ ] Run `cleo config migrate` to apply migration
- [ ] Verify `_meta.schemaVersion` updated correctly

**Post-Migration:**
- [ ] Run `cleo validate` to verify migrated config
- [ ] Run `cleo doctor` to check for warnings
- [ ] Test critical workflows (add, complete, session)
- [ ] Commit migrated config to version control

---

**Version**: 1.0.0
**Status**: Draft
**Last Updated**: 2026-01-29
**Authors**: CLEO Specification Team (T2760)
