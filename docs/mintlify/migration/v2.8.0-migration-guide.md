# Migration Guide: v2.8.0

## Overview

Version 2.8.0 introduces **metadata and roadmap integration** features. This migration adds fields for enhanced task tracking (`updatedAt`, `relates`, `origin`), project-level release management (`releases`), and conversation context preservation (`sessionNotes`). These features enable better task provenance tracking, non-blocking relationships, and roadmap planning.

## What's New in v2.8.0

### Task Modification Tracking

- **updatedAt**: Automatic timestamp on every task mutation for staleness detection and conflict resolution

### Task Relationships

- **relates**: Non-blocking relationships between tasks for semantic connections, provenance tracking, and cross-references

### Task Provenance

- **origin**: Classification of where tasks came from (bug reports, feature requests, technical debt, etc.)

### Release Management

- **releases**: Project-level roadmap tracking with version, status, and task associations

### Session Context Preservation

- **sessionNotes**: Append-only array of session progress notes with conversation context

## Schema Changes

### New Task Fields

**Before (v2.7.0)**:
```json
{
  "id": "T001",
  "title": "Implement feature",
  "status": "pending",
  "priority": "high",
  "createdAt": "2026-01-23T10:00:00Z"
}
```

**After (v2.8.0)**:
```json
{
  "id": "T001",
  "title": "Implement feature",
  "status": "pending",
  "priority": "high",
  "createdAt": "2026-01-23T10:00:00Z",
  "updatedAt": "2026-01-23T12:30:00Z",
  "origin": "feature-request",
  "relates": [
    {
      "taskId": "T042",
      "type": "spawned-from",
      "reason": "Extracted from parent epic"
    }
  ]
}
```

### Field Definitions

#### updatedAt

| Property | Value |
|----------|-------|
| Type | `string` (date-time) or `null` |
| Default | `null` |
| Auto-set | On any task mutation |
| Purpose | Track last modification timestamp |

**Use Cases**:
- Staleness detection in multi-agent workflows
- Conflict resolution when multiple writers
- Audit trail for task modifications

**Example**:
```json
{
  "id": "T001",
  "updatedAt": "2026-01-23T14:30:00Z"
}
```

#### relates

| Property | Value |
|----------|-------|
| Type | Array of relationship objects |
| Default | `[]` |
| Purpose | Non-blocking task relationships |

**Relationship Types**:

| Type | Description | Use Case |
|------|-------------|----------|
| `relates-to` | General relationship | Cross-reference between related features |
| `spawned-from` | Derived from another task | Task created during epic decomposition |
| `deferred-to` | Postponed to future task | Work delayed to future version |
| `supersedes` | Replaces another task | Redesign that obsoletes previous approach |
| `duplicates` | Same as another task | Duplicate detection |

**Example**:
```json
{
  "id": "T050",
  "relates": [
    {
      "taskId": "T001",
      "type": "spawned-from",
      "reason": "Extracted during epic decomposition"
    },
    {
      "taskId": "T042",
      "type": "relates-to",
      "reason": "Both involve authentication logic"
    }
  ]
}
```

**Comparison with depends**:

| Field | Relationship Type | Blocks Start? | Use Case |
|-------|------------------|---------------|----------|
| `depends` | Must complete first | Yes | Sequential work order |
| `relates` | Semantic connection | No | Cross-references, provenance |

#### origin

| Property | Value |
|----------|-------|
| Type | Enum string or `null` |
| Values | `internal`, `bug-report`, `feature-request`, `security`, `technical-debt`, `dependency`, `regression` |
| Default | `null` |
| Purpose | Task provenance classification |

**Origin Values**:

| Value | Description | Example |
|-------|-------------|---------|
| `internal` | Internally identified improvement | Code cleanup |
| `bug-report` | From user bug report | Issue #123 |
| `feature-request` | User feature request | Community suggestion |
| `security` | Security vulnerability | CVE fix |
| `technical-debt` | Technical debt paydown | Refactoring legacy code |
| `dependency` | Dependency update required | Library upgrade |
| `regression` | Fix for broken behavior | Test failure |

**Example**:
```json
{
  "id": "T100",
  "title": "Fix login timeout",
  "origin": "bug-report"
}
```

**CLI Usage**:
```bash
cleo add "Fix vulnerability" --origin security
cleo update T100 --origin bug-report
cleo list --origin technical-debt
```

### New Project Field: releases

| Property | Value |
|----------|-------|
| Type | Array of release objects |
| Default | `[]` |
| Purpose | Roadmap and version tracking |

**Release Object Structure**:
```json
{
  "version": "v0.65.0",
  "status": "active",
  "targetDate": "2026-02-01",
  "releasedAt": null,
  "tasks": ["T001", "T002", "T003"],
  "notes": "First stable release with roadmap integration"
}
```

**Release Status Values**:

| Status | Description |
|--------|-------------|
| `planned` | Future release, not started |
| `active` | Currently in development |
| `released` | Shipped to production |

**Example in todo.json**:
```json
{
  "project": {
    "name": "my-project",
    "releases": [
      {
        "version": "v0.64.0",
        "status": "released",
        "releasedAt": "2026-01-20T10:00:00Z",
        "tasks": ["T045", "T046", "T047"]
      },
      {
        "version": "v0.65.0",
        "status": "active",
        "targetDate": "2026-02-01",
        "tasks": ["T050", "T051"]
      }
    ]
  }
}
```

### New Focus Field: sessionNotes

| Property | Value |
|----------|-------|
| Type | Array of session note objects |
| Default | `[]` |
| Max Items | 50 |
| Purpose | Preserve conversation context across sessions |

**Session Note Structure**:
```json
{
  "note": "Completed authentication module, starting on user profile",
  "timestamp": "2026-01-23T14:30:00Z",
  "conversationId": "conv_abc123",
  "agent": "opus-1"
}
```

**Comparison with sessionNote**:

| Field | Type | Behavior | Use Case |
|-------|------|----------|----------|
| `sessionNote` | Single string | Replaced on each update | Current session context (deprecated) |
| `sessionNotes` | Array | Append-only | Historical session context |

**Example**:
```json
{
  "focus": {
    "currentTask": "T050",
    "sessionNote": "Working on API endpoints",
    "sessionNotes": [
      {
        "note": "Started authentication epic",
        "timestamp": "2026-01-22T10:00:00Z",
        "agent": "opus-1"
      },
      {
        "note": "Completed login flow, moving to registration",
        "timestamp": "2026-01-23T09:00:00Z",
        "agent": "opus-1"
      }
    ]
  }
}
```

## Migration Process

### Automatic Migration (Recommended)

```bash
# 1. Check current version
cleo migrate status

# 2. Run migration (creates backup automatically)
cleo upgrade

# 3. Verify migration
cleo validate
```

**Expected Output**:
```
Migrating .cleo/todo.json from v2.7.0 to v2.8.0...
  Creating backup: .cleo/backups/migration/pre-migration-20260123-120000/
  Step 1: Migrating to v2.8.0...
  - Adding updatedAt field (null default) to all tasks
  - Adding relates array (empty default) to all tasks
  - Adding origin field (null default) to all tasks
  - Adding releases array to project
  - Adding sessionNotes array to focus
Migration successful: .cleo/todo.json
```

### Migration Steps (What Happens)

1. **Pre-Migration Backup**: Complete backup created in `.cleo/backups/migration/`
2. **Task Field Addition**:
   - Add `updatedAt: null` to all tasks
   - Add `relates: []` to all tasks
   - Add `origin: null` to all tasks
3. **Project Field Addition**:
   - Add `releases: []` to project object
4. **Focus Field Addition**:
   - Add `sessionNotes: []` to focus object
5. **Version Update**: Update `version` and `_meta.schemaVersion` to `2.8.0`
6. **Validation**: Validate migrated file against v2.8.0 schema
7. **Logging**: Record migration in `.cleo/.migration.log`

### Verify Before Migration

```bash
# Current schema version
jq '.version' .cleo/todo.json
# Expected: "2.7.0"

# Check task count
jq '.tasks | length' .cleo/todo.json

# Verify backup system working
cleo backup --list
```

## Rollback Procedure

### Automatic Rollback

```bash
# List available migration backups
ls -la .cleo/backups/migration/

# Rollback using restore command
cleo restore

# Or specify backup
cleo restore --backup migration_v2.7.0_20260123_120000
```

### Manual Rollback

```bash
# 1. Identify backup directory
BACKUP_DIR=$(ls -td .cleo/backups/migration/pre-migration-* | head -1)

# 2. Restore todo.json
cp "$BACKUP_DIR/todo.json" .cleo/todo.json

# 3. Verify restoration
jq '.version' .cleo/todo.json  # Should show "2.7.0"

# 4. Validate
cleo validate
```

## Post-Migration Usage

### Using updatedAt

The `updatedAt` field is automatically set by CLEO on any task mutation:

```bash
# Update triggers updatedAt
cleo update T001 --priority high
# updatedAt now reflects current timestamp

# Query recently modified tasks
cleo list | jq '.tasks | sort_by(.updatedAt) | reverse | .[0:5]'
```

### Using relates

```bash
# Add relationship via CLI
cleo update T050 --relates T001:spawned-from:"Extracted from parent epic"

# View relationships
cleo show T050 --related

# Find all tasks related to a specific task
cleo find --relates-to T001
```

### Using origin

```bash
# Add origin on task creation
cleo add "Fix security vulnerability" --origin security --priority critical

# Update existing task origin
cleo update T100 --origin bug-report

# Filter by origin
cleo list --origin security
cleo list --origin technical-debt
```

### Using releases

```bash
# View releases
cleo releases

# Add task to release
cleo release add v0.65.0 T050

# Create new release
cleo release create v0.66.0 --status planned --target 2026-03-01

# Mark release as shipped
cleo release ship v0.65.0
```

### Using sessionNotes

```bash
# Add session note (preserves history)
cleo focus note "Completed login module, starting registration"

# View session notes
cleo focus show --notes

# Clear old session notes (keeps last 10)
cleo focus notes --trim 10
```

## Breaking Changes

### None

Version 2.8.0 is fully backward compatible. All new fields have default values that preserve existing behavior.

### Backward Compatibility

- **Read Operations**: v2.8.0 CLI can read v2.7.0 files (missing fields default to sensible values)
- **Write Operations**: After migration, older CLI versions may fail validation due to unknown fields
- **Recommendation**: Upgrade all team members to v2.8.0 after migration

## Data Preservation Guarantees

The migration process preserves:

- All task data (id, title, description, status, hierarchy, etc.)
- Task metadata (timestamps, labels, dependencies)
- Phase assignments and history
- Focus state and session information
- All `_meta` fields (checksum, etc.)
- Archive and log files (unchanged in v2.8.0)

## Migration Checklist

- [ ] Read this migration guide completely
- [ ] Review CHANGELOG.md for v2.8.0 changes
- [ ] Commit current work to git
- [ ] Create manual backup: `cp -r .cleo .cleo.backup.$(date +%Y%m%d)`
- [ ] Verify current version: `cleo migrate status`
- [ ] Run migration: `cleo upgrade`
- [ ] Verify migration success: `cleo validate`
- [ ] Test new fields: `cleo list | jq '.tasks[0] | {updatedAt, relates, origin}'`
- [ ] Update team members to v2.8.0
- [ ] Clean up old backups (after 30 days)

## Summary

**What Changed**:
- New task fields: `updatedAt`, `relates`, `origin`
- New project field: `releases`
- New focus field: `sessionNotes`

**Migration Method**:
- Automatic: `cleo upgrade`
- Rollback: `cleo restore`

**Safety**:
- Automatic backups before migration
- All new fields have safe defaults
- Validation after migration
- Rollback capability
- Data preservation guaranteed

**Next Steps**:
1. Run migration
2. Start using `origin` field for task provenance
3. Establish task relationships with `relates`
4. Set up release tracking with `releases`
5. Use `sessionNotes` for conversation context
