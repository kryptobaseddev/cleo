# Migration Guide: v2.2.0

## Overview

Version 2.2.0 introduces **project phases** - a structured workflow system for organizing tasks into sequential stages (setup → core → polish → release). This migration transforms the `project` field from a simple string to a rich object with phase tracking capabilities.

## What's New in v2.2.0

### Project Phases Feature

- **Structured Workflow**: Organize tasks into predefined phases with lifecycle tracking
- **Phase Metadata**: Each phase includes order, name, description, status, and timestamps
- **Active Phase Tracking**: Track which phase is currently active
- **Progress Visualization**: New `phases` command with progress bars and statistics
- **Task-Phase Association**: Tasks can be assigned to specific phases via `--phase` flag

### New Commands

```bash
cleo phases                   # List all phases with progress
cleo phases show <phase>      # Show tasks in specific phase
cleo phases stats             # Detailed phase statistics
```

### Enhanced Dashboard

The `dash` command now includes phase information and progress indicators.

## Schema Changes

### Breaking Change: project Field

**Before (v2.1.0)**:
```json
{
  "version": "2.1.0",
  "project": "cleo"
}
```

**After (v2.2.0)**:
```json
{
  "version": "2.2.0",
  "project": {
    "name": "cleo",
    "currentPhase": null,
    "phases": {
      "setup": {
        "order": 1,
        "name": "Setup",
        "description": "Initial setup and configuration",
        "status": "pending",
        "startedAt": null,
        "completedAt": null
      },
      "core": {
        "order": 2,
        "name": "Core",
        "description": "Core feature implementation",
        "status": "pending",
        "startedAt": null,
        "completedAt": null
      },
      "polish": {
        "order": 3,
        "name": "Polish",
        "description": "Refinement and testing",
        "status": "pending",
        "startedAt": null,
        "completedAt": null
      },
      "release": {
        "order": 4,
        "name": "Release",
        "description": "Release preparation",
        "status": "pending",
        "startedAt": null,
        "completedAt": null
      }
    }
  }
}
```

### New Task Field: phase

Tasks can now be assigned to phases:
```json
{
  "id": "T001",
  "title": "Implement feature X",
  "phase": "core",
  "status": "pending"
}
```

## Migration Process

### Automatic Migration (Recommended)

The migration system handles the transformation automatically:

```bash
# 1. Check current version
cleo migrate status

# 2. Run migration (creates backup automatically)
cleo migrate run

# 3. Verify migration
cleo validate
```

**Expected Output**:
```
Migrating .cleo/todo.json from v2.1.0 to v2.2.0...
  Creating backup: .cleo/backups/migration/pre-migration-20251215-120000/
  Backup created: .cleo/backups/migration/pre-migration-20251215-120000/todo.json
  Step 1: Migrating to v2.2.0...
✓ Migration successful: .cleo/todo.json

All files migrated successfully.
```

### Migration Steps (What Happens)

1. **Pre-Migration Backup**: Complete backup created in `.cleo/backups/migration/`
2. **Project Field Detection**: Detects if `project` is a string (v2.1.0 format)
3. **Field Transformation**:
   - Extract project name from string value
   - Create `project` object with `name`, `currentPhase`, and `phases`
   - Initialize 4 default phases: setup, core, polish, release
   - Set all phases to `pending` status
   - Initialize timestamps to `null`
4. **Version Update**: Update `version` field to `2.2.0`
5. **Validation**: Validate migrated file against v2.2.0 schema
6. **Logging**: Record migration in `.cleo/.migration.log`

### Non-Interactive Migration

For CI/CD environments or scripts:

```bash
# Auto-migrate without confirmation
cleo migrate run --auto

# Skip backup creation (not recommended)
cleo migrate run --auto --no-backup
```

### Verify Before Migration

Check what will change:

```bash
# Current schema version
jq '.version' .cleo/todo.json

# Current project format
jq '.project' .cleo/todo.json

# Expected changes
cleo migrate check
```

## Manual Migration Steps

If automatic migration fails or you prefer manual control:

### Step 1: Backup Current Data

```bash
# Create backup
cp -r .claude .claude.backup.$(date +%Y%m%d)

# Verify backup
ls -la .claude.backup.*
```

### Step 2: Extract Current Project Name

```bash
# Get current project name
PROJECT_NAME=$(jq -r '.project' .cleo/todo.json)
echo "Project name: $PROJECT_NAME"
```

### Step 3: Transform project Field

```bash
# Create temporary file with new structure
jq --arg name "$PROJECT_NAME" '
  .project = {
    "name": $name,
    "currentPhase": null,
    "phases": {
      "setup": {
        "order": 1,
        "name": "Setup",
        "description": "Initial setup and configuration",
        "status": "pending",
        "startedAt": null,
        "completedAt": null
      },
      "core": {
        "order": 2,
        "name": "Core",
        "description": "Core feature implementation",
        "status": "pending",
        "startedAt": null,
        "completedAt": null
      },
      "polish": {
        "order": 3,
        "name": "Polish",
        "description": "Refinement and testing",
        "status": "pending",
        "startedAt": null,
        "completedAt": null
      },
      "release": {
        "order": 4,
        "name": "Release",
        "description": "Release preparation",
        "status": "pending",
        "startedAt": null,
        "completedAt": null
      }
    }
  }
' .cleo/todo.json > .cleo/todo.json.tmp
```

### Step 4: Update Version Field

```bash
jq '.version = "2.2.0"' .cleo/todo.json.tmp > .cleo/todo.json.new
```

### Step 5: Validate and Replace

```bash
# Validate new file
jsonlint .cleo/todo.json.new

# Verify project structure
jq '.project' .cleo/todo.json.new

# Replace original
mv .cleo/todo.json.new .cleo/todo.json
rm .cleo/todo.json.tmp

# Validate with cleo
cleo validate
```

## Rollback Procedure

### Automatic Rollback

If migration created a backup:

```bash
# List available migration backups
ls -la .cleo/backups/migration/

# Rollback using migrate command
cleo migrate rollback

# Or specify backup ID
cleo migrate rollback --backup-id migration_v2.1.0_20251215_120000
```

### Manual Rollback

If automatic rollback fails:

```bash
# 1. Identify backup directory
BACKUP_DIR=$(ls -td .cleo/backups/migration/pre-migration-* | head -1)

# 2. Restore todo.json
cp "$BACKUP_DIR/todo.json" .cleo/todo.json

# 3. Verify restoration
jq '.version' .cleo/todo.json  # Should show "2.1.0"

# 4. Validate
cleo validate
```

### Restore from Manual Backup

If you created manual backup before migration:

```bash
# Restore entire .claude directory
rm -rf .claude
cp -r .claude.backup.YYYYMMDD .claude

# Verify
cleo validate
```

## Post-Migration Setup

### Assign Tasks to Phases

After migration, assign existing tasks to appropriate phases:

```bash
# Assign task to phase
cleo update T001 --phase setup
cleo update T002 --phase core

# Or when creating new tasks
cleo add "New feature" --phase core
```

### Activate a Phase

Start working on a phase:

```bash
# View all phases
cleo phases

# Start working on setup phase (marks phase as active)
# This happens automatically when you focus on a task in that phase
cleo focus set T001
```

### View Phase Progress

```bash
# Overview with progress bars
cleo phases

# Detailed statistics
cleo phases stats

# Tasks in specific phase
cleo phases show core
```

## Breaking Changes

### API Changes

**Breaking**: The `project` field is no longer a string. Code that reads `.project` directly will receive an object instead.

**Before**:
```bash
PROJECT_NAME=$(jq -r '.project' .cleo/todo.json)
# Returns: "cleo"
```

**After**:
```bash
PROJECT_NAME=$(jq -r '.project.name' .cleo/todo.json)
# Returns: "cleo"
```

### Backward Compatibility

- **Read Operations**: v2.2.0 CLI can read v2.1.0 files (project string is detected and handled)
- **Write Operations**: After migration, v2.1.0 CLI cannot read v2.2.0 files (will fail validation)
- **Recommendation**: Upgrade all team members to v2.2.0 after migration

## Troubleshooting

### Issue 1: Migration Fails with "Invalid JSON"

**Symptoms**:
```
ERROR: Failed to migrate project field
```

**Cause**: Corrupted todo.json file

**Solution**:
```bash
# Validate current file
jq '.' .cleo/todo.json

# If invalid, restore from last known good backup
cleo restore
```

### Issue 2: "Project field already an object"

**Symptoms**:
Migration completes but version still shows 2.1.0

**Cause**: Partial migration or file manually edited

**Solution**:
```bash
# Check current state
jq '{version, project}' .cleo/todo.json

# If project is object but version is wrong, update manually
jq '.version = "2.2.0"' .cleo/todo.json > .cleo/todo.json.tmp
mv .cleo/todo.json.tmp .cleo/todo.json

# Validate
cleo validate
```

### Issue 3: Missing Phases After Migration

**Symptoms**:
```bash
cleo phases
# Shows: No phases defined
```

**Cause**: Migration created object but phases are empty

**Solution**:
```bash
# Re-run migration with force flag
cleo migrate run --force

# Or manually add phases using update command
# (Future versions will support this)
```

### Issue 4: Tasks Have Invalid Phase References

**Symptoms**:
```
ERROR: Phase 'old-phase' not found. Valid phases: setup, core, polish, release
```

**Cause**: Tasks have `phase` field with non-standard phase slugs from pre-migration

**Solution**:
```bash
# Find tasks with invalid phases
jq '.tasks[] | select(.phase != null and (.phase | IN("setup", "core", "polish", "release") | not))' .cleo/todo.json

# Update each task
cleo update T001 --phase core
```

### Issue 5: Checksum Mismatch After Migration

**Symptoms**:
```
WARNING: Checksum mismatch detected
```

**Cause**: Migration updated file but checksum not recalculated

**Solution**:
```bash
# Fix checksum
cleo validate --fix
```

### Issue 6: "Migration backup not found"

**Symptoms**:
Cannot rollback, backup directory empty

**Cause**: Migration run with `--no-backup` flag

**Solution**:
```bash
# Check for manual backups
ls -la .claude.backup.*

# If none exist, restore from git
git checkout .cleo/todo.json

# Or re-initialize (DESTRUCTIVE)
cleo init --force
```

## Data Preservation Guarantees

The migration process preserves:

- All task data (id, title, description, status, etc.)
- Task metadata (timestamps, labels, dependencies)
- Focus state and session information
- All metadata fields (`_meta.checksum`, etc.)
- Archive and log files (unchanged in v2.2.0)

## Best Practices

### Before Migration

1. **Commit Changes**: Ensure git working directory is clean
   ```bash
   git status
   git commit -am "Pre-v2.2.0 migration checkpoint"
   ```

2. **Verify Backups**: Ensure backup system working
   ```bash
   cleo backup
   cleo backup --list
   ```

3. **Test on Copy**: Try migration on project copy first
   ```bash
   cp -r .claude .claude.test
   # Test migration on .claude.test
   ```

4. **Review Changelog**: Understand what's changing
   ```bash
   cat ~/.cleo/CHANGELOG.md | grep "2.2.0" -A 50
   ```

### During Migration

1. **Use Default Settings**: Let migration auto-detect format
2. **Keep Backups**: Don't use `--no-backup` flag
3. **Monitor Output**: Watch for warnings or errors
4. **Single Session**: Don't run multiple migrations simultaneously

### After Migration

1. **Validate Data**: Verify all tasks intact
   ```bash
   cleo validate
   cleo list --all
   ```

2. **Test Operations**: Ensure CLI works correctly
   ```bash
   cleo phases
   cleo add "Test task" --phase core
   cleo update T001 --phase setup
   ```

3. **Update Team**: Notify team members to upgrade
4. **Document Changes**: Note any customizations made

## Migration Checklist

Use this checklist to ensure smooth migration:

- [ ] Read this migration guide completely
- [ ] Review CHANGELOG.md for v2.2.0 changes
- [ ] Commit current work to git
- [ ] Create manual backup: `cp -r .claude .claude.backup.$(date +%Y%m%d)`
- [ ] Verify current version: `cleo migrate status`
- [ ] Run migration: `cleo migrate run`
- [ ] Verify migration success: `cleo validate`
- [ ] Check phases: `cleo phases`
- [ ] Test task operations: `cleo list`, `cleo add "Test"`
- [ ] Assign existing tasks to phases
- [ ] Update team members to v2.2.0
- [ ] Clean up old backups (after 30 days)

## Getting Help

If you encounter issues not covered in this guide:

1. **Check Validation**: `cleo validate` often provides specific error messages
2. **Review Logs**: Check `.cleo/.migration.log` for migration details
3. **Restore Backup**: When in doubt, rollback and ask for help
4. **File Issue**: Report migration issues on GitHub with:
   - Version information: `cleo --version`
   - Migration output
   - Validation errors
   - Contents of `.cleo/.migration.log`

## Summary

**What Changed**:
- Project field: string → object with phases
- New commands: `phases`, `phases show`, `phases stats`
- Enhanced dashboard with phase tracking
- Task-phase association via `--phase` flag

**Migration Method**:
- Automatic: `cleo migrate run`
- Manual: Follow manual migration steps above
- Rollback: `cleo migrate rollback`

**Safety**:
- Automatic backups before migration
- Validation after migration
- Rollback capability
- Data preservation guaranteed

**Next Steps**:
1. Run migration
2. Assign tasks to phases
3. Explore new `phases` commands
4. Organize workflow using phase structure
