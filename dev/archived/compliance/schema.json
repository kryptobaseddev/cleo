{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "LLM-Agent-First Compliance Schema",
  "description": "Central validation rules for claude-todo LLM-Agent-First compliance checking",
  "version": "1.0.0",
  "specVersion": "2.1",

  "requirements": {
    "foundation": {
      "libraries": {
        "required": ["exit-codes.sh", "error-json.sh", "output-format.sh"],
        "patterns": {
          "dev_lib_source": "source.*\\$LIB_DIR|source.*CLAUDE_TODO_HOME",
          "dual_path": "source.*\\$LIB_DIR.*\\.sh|source.*CLAUDE_TODO_HOME.*\\.sh"
        }
      },
      "variables": {
        "required": ["COMMAND_NAME", "VERSION"],
        "patterns": {
          "command_name": "^COMMAND_NAME=",
          "version_central": "VERSION=.*CLAUDE_TODO_HOME/VERSION|VERSION=.*SCRIPT_DIR.*VERSION"
        }
      },
      "bash_strict_mode": {
        "required": true,
        "pattern": "^set -euo pipefail",
        "description": "Bash strict mode for error detection and safety"
      }
    },

    "flags": {
      "universal": {
        "required": ["--format", "--quiet"],
        "shortcuts": ["--json", "--human"],
        "patterns": {
          "format_flag": "-f[|]--format|--format[)]",
          "quiet_flag": "-q[|]--quiet|--quiet[)]",
          "json_shortcut": "--json[)]",
          "human_shortcut": "--human[)]",
          "dry_run_flag": "--dry-run\\)"
        }
      },
      "write_commands": {
        "required": ["--dry-run"],
        "commands": ["add", "archive", "complete", "extract", "focus", "inject", "migrate", "reorganize-backups", "phase", "restore", "session", "sync", "update"],
        "patterns": {
          "dry_run_flag": "--dry-run\\)",
          "dry_run_variable": "^DRY_RUN=false",
          "dry_run_json_field": "\"dryRun\"[[:space:]]*:[[:space:]]*true",
          "dry_run_would_naming": "would(Create|Update|Delete|Archive|Restore|Complete|Migrate|Inject|Extract|Set|Start|End)"
        }
      },
      "format_resolution": {
        "required": true,
        "pattern": "resolve_format"
      }
    },

    "json_envelope": {
      "required_fields": ["$schema", "_meta", "success"],
      "meta_fields": ["format", "version", "command", "timestamp"],
      "patterns": {
        "schema_field": "\\\"\\$schema\\\".*v1/output\\.schema\\.json",
        "meta_block": "\\\"_meta\\\"",
        "success_field": "\\\"success\\\".*true|\\\"success\\\".*false"
      }
    },

    "exit_codes": {
      "required_constants": true,
      "pattern": "exit.*\\$EXIT_|exit.*EXIT_",
      "exit_lib_pattern": "exit-codes\\.sh",
      "exit_lib_name": "exit-codes.sh",
      "forbidden": "exit [0-9](?!\\})"
    },

    "error_handling": {
      "required_function": "output_error",
      "defensive_check": "declare -f output_error.*>/dev/null",
      "error_codes_pattern": "E_[A-Z_]+",
      "error_lib_pattern": "error-json\\.sh",
      "error_lib_name": "error-json.sh"
    },

    "input_validation": {
      "description": "Part 5.3 Input Validation Requirements",
      "error_codes": {
        "E_INPUT_MISSING": {
          "exit_code": 2,
          "description": "Required argument missing"
        },
        "E_INPUT_INVALID": {
          "exit_code": 2,
          "description": "Argument value invalid"
        },
        "E_INPUT_FORMAT": {
          "exit_code": 2,
          "description": "Argument format incorrect"
        }
      },
      "validation_order": ["required", "format", "length", "semantic"],
      "field_limits": {
        "title": 120,
        "description": 2000,
        "notes": 500
      },
      "write_commands": ["add", "update", "complete", "archive", "focus", "phase", "session", "sync", "extract", "inject"]
    },

    "robustness": {
      "heredoc_safety": {
        "description": "Unquoted heredocs with literal $ must be escaped to avoid set -u errors",
        "safe_patterns": ["<<[[:space:]]*'EOF'", "\\\\\\$schema"],
        "unsafe_pattern": "<<[[:space:]]*EOF.*\\$schema[^_a-zA-Z0-9]"
      }
    }
  },

  "commands": {
    "write": ["add", "archive", "complete", "focus", "phase", "session", "update"],
    "read": ["analyze", "blockers", "dash", "deps", "exists", "export", "find", "history", "labels", "list", "log", "next", "phases", "show", "stats"],
    "sync": ["extract", "inject", "sync"],
    "maintenance": ["backup", "config", "init", "migrate", "reorganize-backups", "restore", "validate"]
  },

  "commandScripts": {
    "add": "add.sh",
    "analyze": "analyze.sh",
    "archive": "archive.sh",
    "backup": "backup.sh",
    "blockers": "blockers.sh",
    "complete": "complete.sh",
    "config": "config.sh",
    "dash": "dash.sh",
    "deps": "deps.sh",
    "exists": "exists.sh",
    "export": "export.sh",
    "extract": "extract.sh",
    "find": "find.sh",
    "focus": "focus.sh",
    "history": "history.sh",
    "init": "init.sh",
    "inject": "inject.sh",
    "labels": "labels.sh",
    "list": "list.sh",
    "log": "log.sh",
    "migrate": "migrate.sh",
    "reorganize-backups": "reorganize-backups.sh",
    "next": "next.sh",
    "phase": "phase.sh",
    "phases": "phases.sh",
    "restore": "restore.sh",
    "session": "session.sh",
    "show": "show.sh",
    "stats": "stats.sh",
    "sync": "sync.sh",
    "update": "update.sh",
    "validate": "validate.sh"
  },

  "scoring": {
    "foundation_libs": 15,
    "command_name": 5,
    "version_central": 5,
    "bash_strict_mode": 10,
    "format_flag": 10,
    "quiet_flag": 5,
    "json_shortcut": 5,
    "human_shortcut": 5,
    "resolve_format": 15,
    "schema_field": 10,
    "meta_block": 10,
    "success_field": 10,
    "exit_constants": 5,
    "output_error": 5,
    "dry_run": 5
  },

  "thresholds": {
    "pass": 95,
    "warn": 80,
    "fail": 0
  }
}
