{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "claude-todo-schema-v2.1",
  "title": "CLAUDE-TODO Task Schema",
  "description": "LLM-optimized task tracking with integrity verification, session tracking, and anti-hallucination safeguards.",
  "type": "object",
  "required": ["version", "project", "lastUpdated", "tasks", "_meta"],
  "additionalProperties": false,

  "properties": {
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Schema version (semver)"
    },
    "project": {
      "type": "string",
      "minLength": 1,
      "description": "Project identifier for cross-session context."
    },
    "lastUpdated": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of last modification."
    },
    "_meta": {
      "type": "object",
      "description": "System metadata for integrity and session tracking. CRITICAL for anti-hallucination.",
      "required": ["checksum", "configVersion"],
      "additionalProperties": false,
      "properties": {
        "checksum": {
          "type": "string",
          "pattern": "^[a-f0-9]{16}$",
          "description": "SHA-256 truncated hash of tasks array. Verify before ANY write operation."
        },
        "configVersion": {
          "type": "string",
          "description": "Version of todo-config.json used. Ensures config compatibility."
        },
        "lastSessionId": {
          "type": ["string", "null"],
          "description": "Session ID that last modified this file. Format: session_YYYYMMDD_HHMMSS_random"
        },
        "activeSession": {
          "type": ["string", "null"],
          "description": "Currently active session. Null if no session active. Detects orphaned sessions."
        }
      }
    },
    "focus": {
      "type": "object",
      "description": "Session continuity state. CRITICAL for LLM agents to resume work correctly.",
      "additionalProperties": false,
      "properties": {
        "currentTask": {
          "type": ["string", "null"],
          "pattern": "^T\\d{3,}$",
          "description": "Task ID being worked on. MUST match the only task with status='active'. Null if no active task."
        },
        "blockedUntil": {
          "type": ["string", "null"],
          "description": "Global blocker if entire project is blocked."
        },
        "sessionNote": {
          "type": ["string", "null"],
          "maxLength": 1000,
          "description": "Context from last session. Update at session end. Read at session start for continuity."
        },
        "nextAction": {
          "type": ["string", "null"],
          "maxLength": 500,
          "description": "Specific next step when resuming (e.g., 'Add validation to auth.ts:45')."
        }
      }
    },
    "tasks": {
      "type": "array",
      "description": "Flat array of all active tasks. Completed tasks archived via archive-todo.sh.",
      "items": { "$ref": "#/definitions/task" }
    },
    "phases": {
      "type": "object",
      "description": "Optional phase definitions. Keys are slugs referenced by task.phase.",
      "patternProperties": {
        "^[a-z][a-z0-9-]*$": {
          "type": "object",
          "required": ["order", "name"],
          "additionalProperties": false,
          "properties": {
            "order": { "type": "integer", "minimum": 1 },
            "name": { "type": "string", "maxLength": 50 }
          }
        }
      },
      "additionalProperties": false
    },
    "labels": {
      "type": "object",
      "description": "Computed label-to-task-ID index. Derived from task.labels. Regenerate if stale.",
      "patternProperties": {
        "^[a-z][a-z0-9.-]*$": {
          "type": "array",
          "items": { "type": "string", "pattern": "^T\\d{3,}$" }
        }
      },
      "additionalProperties": false
    }
  },

  "definitions": {
    "task": {
      "type": "object",
      "required": ["id", "title", "status", "priority", "createdAt"],
      "additionalProperties": false,
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^T\\d{3,}$",
          "description": "Unique stable ID (T001, T002). NEVER reuse. NEVER change after creation."
        },
        "title": {
          "type": "string",
          "minLength": 1,
          "maxLength": 120,
          "description": "Actionable title starting with verb: 'Implement X', 'Fix Y', 'Add Z'."
        },
        "status": {
          "type": "string",
          "enum": ["pending", "active", "blocked", "done"],
          "description": "pending=ready, active=working (ONE ONLY), blocked=stuck, done=completed."
        },
        "priority": {
          "type": "string",
          "enum": ["critical", "high", "medium", "low"],
          "description": "Task priority. critical > high > medium > low."
        },
        "phase": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*$",
          "description": "Phase slug (must exist in phases object)."
        },
        "description": {
          "type": "string",
          "maxLength": 2000,
          "description": "Detailed requirements, context, and implementation notes."
        },
        "files": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Files to create/modify. Relative paths from project root."
        },
        "acceptance": {
          "type": "array",
          "items": { "type": "string", "maxLength": 200 },
          "minItems": 1,
          "description": "Testable completion criteria. Task is done when ALL are met."
        },
        "depends": {
          "type": "array",
          "items": { "type": "string", "pattern": "^T\\d{3,}$" },
          "uniqueItems": true,
          "description": "Task IDs that must be 'done' before this can start. Validates on activation."
        },
        "blockedBy": {
          "type": "string",
          "maxLength": 300,
          "description": "Blocker reason. REQUIRED when status='blocked'."
        },
        "notes": {
          "type": "array",
          "items": { "type": "string", "maxLength": 500 },
          "description": "Append-only implementation log. NEVER delete entries. Timestamp recommended."
        },
        "labels": {
          "type": "array",
          "items": { "type": "string", "pattern": "^[a-z][a-z0-9.-]*$" },
          "uniqueItems": true,
          "description": "Tags for filtering (bug, feature, security, v0.5.0)."
        },
        "createdAt": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 creation timestamp."
        },
        "completedAt": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 completion timestamp. REQUIRED when status='done'."
        }
      },
      "allOf": [
        {
          "if": { "properties": { "status": { "const": "blocked" } } },
          "then": { "required": ["blockedBy"] }
        },
        {
          "if": { "properties": { "status": { "const": "done" } } },
          "then": { "required": ["completedAt"] }
        }
      ]
    }
  }
}
