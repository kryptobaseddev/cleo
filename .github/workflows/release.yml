name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

permissions:
  contents: write

jobs:
  release:
    name: Build and Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get version from tag
        id: version
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Building release for version: $VERSION"

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run build

      - name: Validate build output
        run: |
          for path in dist/cli/index.js dist/mcp/index.js schemas templates skills; do
            if [[ ! -e "$path" ]]; then
              echo "ERROR: Required path missing: $path"
              exit 1
            fi
          done
          echo "All required build artifacts present"

      - name: Build release tarball
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TARBALL="cleo-${VERSION}.tar.gz"

          mkdir -p "staging/cleo-${VERSION}"

          # Copy npm-publishable components (matches package.json "files")
          cp -r dist "staging/cleo-${VERSION}/"
          cp -r schemas "staging/cleo-${VERSION}/"
          cp -r templates "staging/cleo-${VERSION}/"
          cp -r skills "staging/cleo-${VERSION}/"
          [[ -d completions ]] && cp -r completions "staging/cleo-${VERSION}/"
          cp package.json "staging/cleo-${VERSION}/"
          cp VERSION "staging/cleo-${VERSION}/"
          cp LICENSE "staging/cleo-${VERSION}/"
          cp README.md "staging/cleo-${VERSION}/"
          cp install.sh "staging/cleo-${VERSION}/"

          # Ensure executables have correct permissions
          chmod +x "staging/cleo-${VERSION}/dist/cli/index.js"
          chmod +x "staging/cleo-${VERSION}/dist/mcp/index.js"
          chmod +x "staging/cleo-${VERSION}/install.sh"

          tar -czvf "$TARBALL" -C staging "cleo-${VERSION}"

          echo "Created: $TARBALL"
          ls -lh "$TARBALL"

      - name: Prepare standalone installer
        run: |
          chmod +x install.sh
          echo "Standalone installer ready: $(wc -l < install.sh) lines"

      - name: Generate checksums
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          TARBALL="cleo-${VERSION}.tar.gz"
          sha256sum "$TARBALL" install.sh > SHA256SUMS
          echo "Checksums:"
          cat SHA256SUMS

      - name: Generate release notes
        id: changelog
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          echo "## [${VERSION}] - $(date +%Y-%m-%d)" > release-notes.txt
          echo "" >> release-notes.txt

          # Extract from CHANGELOG.md if available
          if grep -q "## \[${VERSION}\]" CHANGELOG.md 2>/dev/null; then
            echo "Found changelog entry for v${VERSION}"
            # Extract section between this version and the next
            sed -n "/## \[${VERSION}\]/,/## \[/p" CHANGELOG.md | head -n -1 | tail -n +2 >> release-notes.txt
            echo "source=changelog" >> "$GITHUB_OUTPUT"
          else
            echo "No CHANGELOG.md entry - generating from commits"
            PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
            echo "### Changes" >> release-notes.txt
            if [[ -n "$PREV_TAG" ]]; then
              git log --pretty=format:"- %s" --no-merges "${PREV_TAG}..HEAD" >> release-notes.txt
            else
              git log --pretty=format:"- %s" --no-merges -20 >> release-notes.txt
            fi
            echo "" >> release-notes.txt
            echo "source=commits" >> "$GITHUB_OUTPUT"
          fi

          echo ""
          echo "=== Generated Release Notes ==="
          cat release-notes.txt
          echo "==============================="

          echo "path=release-notes.txt" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: ${{ steps.changelog.outputs.path }}
          generate_release_notes: false
          files: |
            cleo-${{ steps.version.outputs.version }}.tar.gz
            install.sh
            SHA256SUMS
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
